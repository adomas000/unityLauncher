
<div ng-controller="searchUnityCtrl" style="height:100%">
    <h3 style="text-align:center;">Search for Unity versions by adding paths or doing automatic search</h3>
    <row id="paths">
         <div class="col-xs-12 col-md-10 col-md-offset-1">
            <div class="input-group path-added-panel">
                <input type="text" class="form-control" disabled="true">
                <span class="input-group-btn">
                    <button class="btn btn-danger remove-path" type="button">delete</button>
                </span>
            </div>
            <!-- /input-group -->
        </div>
        <!-- /.col-lg-6 -->
    </row>
    
    <row>

        <!-- /.col-lg-6 -->    
        <div class="col-xs-12 col-md-10 col-md-offset-1 path-input-wrapper">
            <div class="input-group path-input">
                <input type="file" class="form-control" id="path-input-main" placeholder="Search for...">
                <div class="input-group-btn">
                    <button class="btn btn-default options-path dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" type="button">option<span class="caret"></span></button>
                    <ul class="dropdown-menu dropdown-menu-right">
                        <li><a onclick="pasteDirectory()">Paste path</a></li>
                        <li><a onclick="selectDirectory()" >select path</a></li>
                    </ul>
                    <button class="btn btn-default add-path" type="button">Add</button>
                </div>
            </div>
            <!-- /input-group -->
        </div>
        <!-- /.col-lg-6 -->
    </row>

    <row id="search-footer">
        <div class="col-xs-12 col-md-5 col-md-offset-1">
            <a ng-click="searchWithPaths()"  class="btn btn-success form-control search-btn">Search(fast)</a>
        </div>
        <div class="col-xs-12 col-md-5 ">
            <a ng-click="fullSearch()" class="btn btn-warning form-control search-btn">Full PC search(will take longer)</a>
        </div>
    </row>

    
    <div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog"  id="searchWindow" aria-labelledby="myLargeModalLabel">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-body">                           
                    <pre ng-bind-html-unsafe="all_output" ng-init="all_output='Initializing..\n'"  id="all_output" scroll-glue style="font-size:11px;overflow:auto;width: 100%;height: 200px; resize: none; margin-bottom:5px;border:1px solid #ccc">{{all_output}}</pre>                
                    <pre ng-bind-html-unsafe="found_output" ng-init="found_output='Initializing..\n'" id="res_output" scroll-glue style="font-size:11px;overflow:auto; width: 100%;height: 200px; resize: none; border:1px solid #ccc">{{found_output}}</pre>
                    
                    <div class="row">
                        <div class="col-xs-4" ng-model="count1" ng-init="count1='0'">Found: {{count1}}</div>
                        <div class="col-xs-4" ng-model="count2" ng-init="count2='0'">Scanned: {{count2}}</div>                        
                        <div class="col-xs-12">
                            <a ng-click="stopSearch()" class="btn btn-danger form-control search-btn" data-dismiss="modal">Stop</a>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
    <script>
        var fileSelection = require("./src/js/electronAPI/fileSelection.js");
        var fs = require('fs');
        //var toastr = require('toastr');
        var $paths = $("#paths");
        var $pathNodeClone = $("#paths > div").first().clone(true,true);

        var paths = [];

        (function(){
           
            $("#paths > div").first().remove();

            $("#paths").on("click", ".remove-path",function(){
                //debugger;
                console.log($(this).is($(".remove-path").first()));
                var path = $(this).parents(".path-added-panel").find('input').val();
                var index = paths.indexOf(path);
                if(index < 0)
                {
                    toastr.error("Error when removing path(no such path found in saved) maybe it was already removed?");
                }
                paths.splice(index,index+1);
                $(this).parent().parent().parent().remove();
                toastr.info("path removed succesfully");
                 //:DDDDDD gosh I am tired (it does indeed work)
            });

            $(".add-path").click(function(){
                var path = $(".path-input > input").val();

                var valid = checkIfPathValid(path);
                if(!valid)
                {
                    toastr.error("invalid path");
                    return;
                }
                //var path = $(".path-input > input").files[0].path
                $pathNodeClone.find(".path-added-panel > input").val(path);
                //debugger;
                $paths.append($pathNodeClone.clone());
                toastr.success('path added!');
            })  
            
        })()
        // selecting dir folder
        $("#path-input-main").click(function(e)        
        {
            if($(this).attr('type') =='text') return;
            e.preventDefault();
            //console.log(fileSelection);
            fileSelection.selectDirectory()
            .then(function(path){
                console.log(path[0]);
                emulatePathAdd(path[0]);
            })
            .catch(function(err){
                console.log('path failed: ' + path);
            })

            
        });

        function emulatePathAdd(path)
        {           
            console.log(path);
            var valid = checkIfPathValid(path);
            if(!valid)
            {
                toastr.error("invalid path");
                return;
            }
            $pathNodeClone.find(".path-added-panel > input").val(path);
            $paths.append($pathNodeClone.clone());
            paths.push(path);
            toastr.success('path added!');
        }

        function checkIfPathValid(path)
        {
            
            if (fs.existsSync(path)) {
                
                return true;
            }
            else{
                return false;
            }
        }
        function pasteDirectory()
        {
            $("#path-input-main").attr('type','text');
        }

        function selectDirectory()
        {
            $("#path-input-main").attr('type','file');
        }
        
        $(".search-btn").click(function(){
            $('#searchWindow').modal();
            keepScrollDown();
        })
        var scroll;
        //cancer cancer cancer spent 2 hours ...
        function keepScrollDown()
        {
            //debugger;
            var $fulloutput = $("#all_output");
            var $resoutput  = $("#res_output");

            scroll = setInterval(function(){
                
                $fulloutput.scrollTop($fulloutput.prop('scrollHeight'));
                $resoutput .scrollTop($resoutput.prop('scrollHeight'));
            },10);

        }
        $('#searchWindow').on('hidden.bs.modal', function () {
            console.log("cleared interval");
            clearInterval(scroll);
        })
        
    </script>
</div>